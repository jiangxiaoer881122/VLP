//进行滤波器设计 零相位延迟
#include <stdio.h>
#include <string.h>

// 假设输入信号长度为 1000，滤波器长度为 17 (16 阶滤波器)
#define SIGNAL_LENGTH 1000
#define FILTER_LENGTH 17
#define EXTENDED_LENGTH (SIGNAL_LENGTH + 2*3*(FILTER_LENGTH - 1))  // 延拓后的信号长度
// 定义滤波器系数 b (从 MATLAB 中获取)
float b[] = {
 1.866779e-03, 8.163281e-04, -3.512367e-03, -1.634744e-02, -4.077692e-02, -7.486983e-02, -1.111612e-01, -1.391366e-01, 8.480923e-01, -1.391366e-01, -1.111612e-01, -7.486983e-02, -4.077692e-02, -1.634744e-02, -3.512367e-03, 8.163281e-04, 1.866779e-03  // 前馈系数
};

// FIR 滤波器卷积实现函数
void fir_filter(const float *input, float *output, int input_len, const float *filter, int filter_len) {
    // 初始化输出信号
    for (int n = 0; n < input_len; n++) {
        output[n] = filter[0]*input[n];
        for (int k = 1; k <= filter_len; k++) {
            if (n - k >= 0) {
                output[n] += filter[k] * input[n - k];
            }
        }
    }
}
// 对称延拓信号
void extend_signal(const int *input, float *extended, int input_len, int filter_len) {
    int extend_size = 3*(filter_len - 1);  // 延拓长度
    int i;
    for (i = 0; i < input_len + extend_size * 2; i++)
    {
        if (i < extend_size)
        {
            extended[i] = 2 * input[0] - input[extend_size - i]; //前延拓
        }
        else if (i < input_len + extend_size)
        {
            extended[i] = input[i - extend_size]; //中间数据不变
        }
        else
        {
            extended[i] = 2 * input[input_len - 1] - input[input_len - 2 - (i - input_len - extend_size)]; //后延拓
        }
    }
}
// 数组反转函数
void reverse(float *data, int len) {
    int i, j;
    double temp;
    for (i = 0, j = len - 1; i < j; i++, j--) {
        temp = data[i];
        data[i] = data[j];
        data[j] = temp;
    }
}

int main() {
    // 输入信号（x0），长度为 1000
    int x0[] = {
  128, 92, 131, 69, 117, 100, 100, 74, 132, 75, 117, 140, 110, 122, 116, 140, 104, 146, 117, 130, 107, 123, 103, 124, 73, 133, 83, 99, 116, 103, 123, 116, 143, 92, 132, 117, 138, 107, 143, 98, 128, 97, 123, 92, 101, 83, 106, 100, 96, 144, 75, 119, 108, 128, 101, 153, 112, 135, 113, 139, 98, 135, 88, 118, 121, 81, 134, 95, 104, 109, 119, 88, 149, 119, 129, 118, 140, 101, 134, 112, 125, 121, 95, 117, 91, 110, 83, 120, 67, 124, 112, 117, 107, 147, 89, 132, 118, 143, 108, 118, 134, 97, 128, 96, 116, 95, 107, 102, 121, 90, 146, 98, 115, 124, 138, 101, 127, 138, 99, 129, 108, 123, 94, 126, 83, 111, 88, 112, 95, 107, 95, 139, 87, 130, 153, 90, 134, 115, 128, 107, 145, 103, 126, 98, 120, 79, 122, 81, 121, 94, 122, 135, 109, 116, 126, 133, 101, 152, 111, 130, 116, 124, 85, 113, 90, 100, 82, 123, 93, 96, 119, 95, 139, 88, 141, 121, 125, 114, 153, 90, 137, 104, 116, 87, 127, 91, 89, 128, 93, 123, 100, 130, 115, 139, 97, 162, 109, 127, 122, 124, 90, 138, 90, 104, 120, 92, 105, 83, 124, 91, 132, 100, 125, 108, 122, 109, 146, 92, 142, 115, 114, 131, 102, 114, 89, 125, 89, 118, 105, 126, 86, 135, 97, 136, 113, 140, 124, 139, 104, 124, 119, 93, 141, 88, 106, 97, 120, 79, 112, 92, 109, 96, 142, 100, 143, 106, 120, 142, 91, 142, 117, 113, 112, 130, 79, 123, 92, 105, 83, 132, 104, 128, 122, 129, 137, 108, 138, 117, 147, 98, 151, 83, 115, 110, 104, 71, 123, 78, 114, 102, 133, 100, 99, 139, 92, 143, 116, 132, 113, 116, 105, 138, 82, 134, 94, 96, 101, 126, 87, 98, 137, 89, 129, 120, 143, 107, 142, 107, 132, 114, 133, 119, 106, 85, 133, 72, 91, 139, 70, 115, 104, 134, 91, 135, 107, 120, 104, 149, 105, 146, 96, 128, 96, 100, 132, 92, 100, 105, 128, 82, 134, 110, 124, 98, 141, 114, 138, 131, 138, 103, 134, 106, 97, 116, 83, 135, 68, 117, 106, 109, 85, 140, 93, 125, 118, 149, 93, 140, 110, 91, 136, 103, 124, 98, 114, 97, 120, 71, 139, 101, 107, 112, 143, 98, 140, 120, 122, 133, 124, 138, 99, 147, 93, 122, 80, 112, 104, 101, 83, 135, 76, 123, 123, 115, 126, 116, 143, 97, 147, 107, 119, 96, 130, 84, 128, 82, 128, 86, 101, 105, 136, 88, 123, 144, 99, 155, 120, 130, 108, 145, 98, 124, 115, 121, 86, 106, 78, 118, 82, 95, 144, 86, 135, 121, 117, 100, 149, 97, 129, 116, 136, 87, 123, 95, 102, 89, 109, 128, 94, 122, 110, 136, 79, 155, 102, 123, 123, 151, 96, 137, 116, 124, 88, 135, 109, 81, 122, 85, 125, 84, 120, 101, 114, 102, 154, 90, 130, 122, 124, 101, 143, 107, 83, 130, 89, 109, 88, 123, 83, 127, 89, 143, 105, 123, 122, 136, 96, 160, 122, 104, 150, 106, 117, 86, 138, 77, 112, 90, 115, 88, 129, 94, 135, 87, 136, 128, 120, 144, 124, 118, 94, 138, 84, 115, 98, 120, 74, 122, 95, 117, 98, 126, 111, 141, 122, 125, 148, 88, 154, 97, 119, 116, 140, 80, 127, 92, 111, 81, 125, 91, 119, 106, 101, 139, 101, 133, 113, 121, 106, 152, 90, 135, 104, 105, 80, 127, 82, 113, 94, 109, 123, 106, 138, 103, 138, 104, 144, 116, 135, 128, 129, 83, 141, 97, 110, 103, 115, 108, 84, 131, 86, 128, 105, 130, 98, 144, 104, 148, 91, 133, 108, 119, 99, 139, 77, 76, 122, 79, 119, 104, 133, 96, 138, 107, 131, 116, 137, 107, 142, 104, 154, 112, 76, 138, 82, 105, 102, 130, 80, 134, 93, 115, 99, 138, 92, 133, 113, 136, 118, 119, 133, 100, 110, 88, 135, 68, 123, 98, 105, 86, 133, 88, 135, 112, 142, 104, 149, 147, 107, 140, 98, 140, 101, 118, 108, 114, 70, 132, 82, 111, 112, 125, 90, 138, 121, 100, 142, 114, 134, 100, 139, 90, 133, 76, 119, 90, 98, 85, 138, 75, 139, 105, 97, 138, 120, 146, 105, 149, 110, 133, 107, 131, 96, 130, 81, 135, 89, 117, 105, 104, 113, 117, 129, 98, 148, 107, 129, 106, 139, 91, 133, 109, 122, 97, 122, 85, 117, 94, 86, 135, 77, 146, 110, 121, 106, 147, 95, 137, 117, 146, 99, 150, 97, 121, 100, 84, 118, 89, 115, 112, 121, 85, 152, 87, 123, 117, 135, 105, 150, 111, 123, 100, 108, 107, 92, 115, 81, 121, 76, 120, 104, 109, 115, 141, 91, 156, 123, 130, 113, 136, 130, 97, 143, 92, 115, 88, 113, 83, 127, 88, 142, 88, 126, 120, 123, 101, 155, 109, 101, 148, 105, 121, 95, 123, 73, 113, 92, 114, 93, 119, 88, 131, 86, 147, 116, 88, 158, 120, 123, 116, 142, 87, 124, 98, 126, 83, 136, 88, 112, 91, 121, 106, 112, 132, 122, 124, 104, 158, 91, 130, 111, 126, 89, 135, 92, 109, 78, 119, 70, 122, 128, 95, 135, 100, 145, 117, 122, 129, 145, 88, 147, 114, 120, 100, 127, 75, 107, 120, 91, 118, 108, 126, 96, 137, 103, 157, 90, 138, 121, 123, 96, 152, 77, 114, 95, 91, 106, 96, 118, 75, 119, 106, 120, 110, 134, 112, 143, 88, 160, 113, 123, 116, 120, 109, 108, 123, 77, 107, 98, 114, 92, 146, 100, 126, 104, 131, 114, 134, 109, 147, 118, 100, 147, 74, 111, 90, 102, 74, 128, 96, 114, 93, 137, 83, 141, 111, 151, 127, 106, 149, 110, 114, 116, 117, 71, 132, 95, 107, 92, 132, 84, 118, 116, 137, 107, 120, 136, 103, 132, 103, 140, 82, 119, 108, 101, 83, 133, 74, 112, 98, 125, 87, 126, 143, 90, 135, 112, 136, 114, 135} ;
    // 中间步骤的正向滤波结果和最终的输出信号
    float extended_signal[EXTENDED_LENGTH];
    float y_forward[EXTENDED_LENGTH];
    float y_final[EXTENDED_LENGTH];
    // 最终输出信号 (只保留原始长度的部分)
    float y[SIGNAL_LENGTH];
    extend_signal(x0, extended_signal, SIGNAL_LENGTH, FILTER_LENGTH);
    // 第一步：正向滤波
    fir_filter(extended_signal, y_forward, EXTENDED_LENGTH, b, FILTER_LENGTH);
    // 第二步：反转正向滤波结果
    reverse(y_forward, EXTENDED_LENGTH);
    // 第三步：对反转后的信号再次进行滤波
    fir_filter(y_forward, y_final, EXTENDED_LENGTH, b, FILTER_LENGTH);
    // 第四步：再将结果反转回来，得到最终的滤波输出
    reverse(y_final, EXTENDED_LENGTH);
    // 第六步：去除延拓部分，保留原始信号长度
    for (int i = 0; i < SIGNAL_LENGTH; i++) {
        y[i] = y_final[3*(FILTER_LENGTH - 1) + i];
    }
    // 输出最终滤波结果
    for (int i = 0; i < SIGNAL_LENGTH; i++) {
        printf("y[%d] = %f\n", i, y[i]);
    }
    return 0;
}
